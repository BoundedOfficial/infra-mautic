services:
  db:
    image: mariadb:10.11
    environment:
      MARIADB_DATABASE: mautic_db
      MARIADB_USER: webadmin_db
      MARIADB_PASSWORD_FILE: /run/secrets/mautic/mautic_db_password
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/mautic/mautic_db_root_password

    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-allowed-packet=256M

    volumes:
      - db_data:/var/lib/mysql
      - /run/secrets/mautic:/run/secrets/mautic:ro

    healthcheck:
      # use CMD-SHELL so we can cat the root password from the secret file
      test: ["CMD-SHELL", "mysqladmin ping -p$(cat /run/secrets/mautic/mautic_db_root_password)"]
      interval: 10s
      timeout: 5s
      retries: 30

    networks:
      - bounded-net
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server","--appendonly","yes"]
    volumes:
      - redis_data:/data
    networks:
      - bounded-net
    restart: unless-stopped

  mautic:
    build: .
    image: mautic-redis:5-apache
    depends_on:
      db:
        condition: service_healthy

    environment:
      #Credentials will be injected by entrypoint
      MAUTIC_DB_HOST: db
      MAUTIC_DB_PORT: "3306"
      MAUTIC_DB_NAME: mautic_db
      MAUTIC_DB_USER: webadmin_db
      MAUTIC_URL: https://mautic.boundedstudios.com

      # trust traefik / cloudflare
      MAUTIC_TRUSTED_PROXIES: '["0.0.0.0/0","::/0"]'

      # timezone & php tweaks
      PHP_INI_DATE_TIMEZONE: Europe/Sofia
      PHP_INI_MEMORY_LIMIT: 512M

      # Redis queue
      MAUTIC_MESSENGER_DSN: "redis://redis:6379/messages"

    volumes:
      - mautic_var:/var/www/html/var
      - mautic_media:/var/www/html/media
      - mautic_config:/var/www/html/config
      - /run/secrets/mautic:/run/secrets/mautic:ro

    labels:
      - traefik.enable=true
      - traefik.http.routers.mautic.rule=Host(`mautic.boundedstudios.com`)
      - traefik.http.routers.mautic.entrypoints=websecure
      - traefik.http.routers.mautic.tls.certresolver=le
      - traefik.http.services.mautic.loadbalancer.server.port=80

      # CORS so boundedstudios.com can embed Mautic forms
      - traefik.http.middlewares.mautic-cors.headers.accessControlAllowOriginList=https://boundedstudios.com,https://www.boundedstudios.com
      - traefik.http.middlewares.mautic-cors.headers.accessControlAllowMethods=GET,POST,OPTIONS
      - traefik.http.middlewares.mautic-cors.headers.accessControlAllowHeaders=Content-Type,Accept,X-Requested-With,Authorization
      - traefik.http.middlewares.mautic-cors.headers.accessControlAllowCredentials=true
      - traefik.http.middlewares.mautic-cors.headers.accessControlMaxAge=600
      - traefik.http.routers.mautic.middlewares=mautic-cors@docker

    networks:
      - bounded-net
    restart: unless-stopped

volumes:
  db_data:
  mautic_var:
  mautic_media:
  redis_data:
  mautic_config:

networks:
  bounded-net:
    external: true
